<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Encore! • Vote</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bgDeep1:#1B0930; --bgDeep2:#16072A;
    --txt:#fff; --sub:#d8c7ff;
    --green:#25d366; --yellow:#f6c945; --red:#ff5e6c;
    --line:#6f52a8;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,var(--bgDeep1),var(--bgDeep2));color:var(--txt);font:17px/1.4 "Montserrat",system-ui}
  .wrap{min-height:100svh;display:flex;flex-direction:column;gap:16px;padding:22px}
  h1{margin:0;font-size:28px}
  .sub{color:var(--sub)}
  .pin{display:grid;grid-template-columns:1fr auto;gap:8px}
  input{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.25);background:#220d3f;color:#fff}
  button{padding:12px 14px;border-radius:10px;border:0;font-weight:800;cursor:pointer}
  .row{display:grid;grid-template-columns:1fr;gap:10px}
  .btnG{background:var(--green);color:#042a13}
  .btnY{background:var(--yellow);color:#352600}
  .btnR{background:var(--red);color:#2b0e12}
  .muted{color:#b8a8e8}
  .hidden{display:none}
  .foot{margin-top:auto;opacity:.85}
  .mini{font-size:12px}
  .msg{min-height:18px}
  .voteRow{display:grid;grid-template-columns:1fr;gap:10px}
  .who{border:1px dashed rgba(255,255,255,.25);padding:10px;border-radius:10px;background:#210d3f}
</style>
</head>
<body>
<div class="wrap">

  <header>
    <h1 id="venueTitle">Encore! Vote</h1>
    <div class="sub" id="nowSinging">&nbsp;</div>
  </header>

  <section id="unlock">
    <div class="sub">Enter Event PIN to vote</div>
    <div class="pin" style="margin-top:6px">
      <input id="pin" inputmode="numeric" placeholder="Event PIN" />
      <button id="unlockBtn" class="btnG">Unlock</button>
    </div>
    <div class="msg mini" id="unlockMsg"></div>
  </section>

  <section id="voteUI" class="hidden">
    <div class="who">
      <div class="mini muted">Voting for</div>
      <div id="singer" style="font-weight:800;font-size:20px">—</div>
    </div>

    <div class="voteRow" style="margin-top:10px">
      <button class="btnG" id="v_encore">Encore!</button>
      <button class="btnY" id="v_another">Another Shot!</button>
      <button class="btnR" id="v_maybe">Maybe Next Time!</button>
    </div>

    <div class="msg" id="voteMsg"></div>

    <div class="mini muted foot">
      One vote per device per singer is recorded.
    </div>
  </section>

  <!-- Overlay result -->
  <div id="overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);align-items:center;justify-content:center;z-index:9998">
    <div id="ovCard" class="ovCard" style="padding:20px 18px;border-radius:16px;text-align:center;border:2px solid #6f52a8;background:linear-gradient(180deg,#1B0930,#16072A);min-width:270px">
      <div id="ovTitle" style="font-size:26px;font-weight:800">—</div>
      <div id="ovSub" class="sub" style="margin-top:6px">—</div>
    </div>
  </div>

</div>

<script>
const GET_URL='/assets/get_state.php';
const VOTE_URL='/assets/vote.php';

const $=s=>document.querySelector(s);
const pin=$('#pin'), unlockBtn=$('#unlockBtn'), unlockMsg=$('#unlockMsg');
const unlockSection=$('#unlock'), voteUI=$('#voteUI');
const singerEl=$('#singer'), venueTitle=$('#venueTitle'), nowSinging=$('#nowSinging');
const vE=$('#v_encore'), vA=$('#v_another'), vM=$('#v_maybe');
let state=null, eventPin='', currentSingerId=null;
let overlayTimer=null;

function deviceId(){
  try{
    const k='eyek_device'; let v=localStorage.getItem(k);
    if(!v){ v='d_'+Math.random().toString(36).slice(2,11); localStorage.setItem(k,v); }
    return v;
  }catch(e){ return 'na_'+Math.random().toString(36).slice(2,7); }
}

async function fetchState(){
  const r=await fetch(GET_URL,{cache:'no-store'}); state=await r.json();
  const s=state||{};
  const e=s.event||{}; const c=s.current||{}; const v=s.voting||{};
  venueTitle.textContent = e.venuePublic || e.venue || 'Encore! Vote';
  nowSinging.textContent = c.name ? ('Now singing: '+c.name) : '';
  currentSingerId = c.id || null;
  singerEl.textContent = c.name || '—';
  // Pin stays the one you typed; we just need it to unlock
}

function setUnlocked(on){ unlockSection.classList.toggle('hidden', on); voteUI.classList.toggle('hidden', !on); }

unlockBtn.addEventListener('click', async ()=>{
  eventPin = (pin.value||'').trim();
  if(!eventPin){ unlockMsg.textContent='Enter the event PIN.'; return; }
  // For now we just unlock locally; server validates on vote
  setUnlocked(true); unlockMsg.textContent='';
  await fetchState();
});

async function sendVote(kind){
  if(!currentSingerId){ voteMsg.textContent='No singer set yet.'; return; }
  const body={ pin:eventPin, singer: currentSingerId, vote:kind, device: deviceId() };
  try{
    const r=await fetch(VOTE_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    if(!r.ok){ const e=await r.json().catch(()=>({error:'vote_failed'})); throw new Error(e.error||'vote_failed'); }
    showOverlay(kind, kind==='encore'?'Encore! Congratulations!':(kind==='another'?'Another Shot!':'Maybe Next Time!'), 'Vote received');
  }catch(e){
    const m=(e.message||''); if(m.includes('already')||m.includes('once')){ showOverlay('another','Already Voted','One vote per device per singer'); }
    else { showOverlay('maybe','Error','Please try again'); }
  }
  await fetchState();
}

vE.addEventListener('click', ()=>sendVote('encore'));
vA.addEventListener('click', ()=>sendVote('another'));
vM.addEventListener('click', ()=>sendVote('maybe'));

setInterval(fetchState, 8000);
fetchState();

function showOverlay(kind, title, sub){
  const ov=$('#overlay'), card=$('#ovCard');
  document.getElementById('ovTitle').textContent=title;
  document.getElementById('ovSub').textContent=sub;
  card.className='ovCard '+(kind==='encore'?'ov-enc':kind==='another'?'ov-ano':'ov-may');
  ov.style.display='flex';
  clearTimeout(overlayTimer);
  overlayTimer=setTimeout(()=>{ ov.style.display='none'; }, 15000);
}
function hideOverlay(){ const ov=$('#overlay'); if(ov.style.display!=='none') ov.style.display='none'; }
</script>

<!-- ===== COUPON BANNER (Audience) — shows at bottom of Vote page ===== -->
<style>
  #couponBanner {
    position: fixed; left: 12px; right: 12px; bottom: 12px; z-index: 9999;
    display: none; gap: 10px; align-items: center;
    padding: 10px 12px; border-radius: 12px;
    background: linear-gradient(180deg, var(--bgDeep1), var(--bgDeep2));
    border: 1px solid var(--line); color: var(--txt);
    box-shadow: 0 8px 28px rgba(0,0,0,.35);
  }
  #couponBanner img { height: 44px; width: 44px; object-fit: cover; border-radius: 8px; border:1px solid var(--line); display:none }
  #couponBanner .txt { font: 600 14px/1.35 Montserrat, system-ui; }
  #couponBanner a { color: #B692FF; text-decoration: none; font-weight: 700; display:none }
  #couponClose { margin-left: auto; background: #2a1352; border:1px solid var(--line); color:#fff; padding:6px 10px; border-radius:10px; cursor:pointer; }
  @media (max-width:600px){ #couponBanner { left: 8px; right: 8px; bottom: 8px; } }
</style>
<div id="couponBanner" role="region" aria-label="Venue Coupon">
  <img id="couponImg" alt="Coupon image" />
  <div class="txt" id="couponTextOut">—</div>
  <a id="couponLinkOut" href="#" target="_blank" rel="noopener">View</a>
  <button id="couponClose" type="button">Close</button>
</div>
<script>
(function(){
  const GET_URL='/assets/get_state.php';
  const el=document.getElementById('couponBanner');
  const img=document.getElementById('couponImg');
  const txt=document.getElementById('couponTextOut');
  const a=document.getElementById('couponLinkOut');
  const closeBtn=document.getElementById('couponClose');
  let dismissed=false;

  function isExpired(iso){
    if(!iso) return false;
    const t=Date.parse(iso); if(isNaN(t)) return false;
    return Date.now() > t;
  }

  function renderCoupon(c){
    if(!c || !c.couponText || isExpired(c.expiresAt) || dismissed){ el.style.display='none'; return; }
    txt.textContent = c.couponText || '';
    if(c.couponImageUrl){ img.src=c.couponImageUrl; img.style.display=''; } else { img.style.display='none'; }
    if(c.couponLink){ a.href=c.couponLink; a.style.display=''; } else { a.style.display='none'; }
    el.style.display='flex';
  }

  async function fetchStateOnce(){
    try{
      const r=await fetch(GET_URL,{cache:'no-store'});
      const s=await r.json();
      const coupon = (s?.event?.coupon) || (s?.state?.event?.coupon) || null;
      renderCoupon(coupon);
    }catch(e){ /* silent */ }
  }

  closeBtn.addEventListener('click', ()=>{ dismissed=true; el.style.display='none'; });

  fetchStateOnce();
  setInterval(fetchStateOnce, 10000);
})();
</script>

</body>
</html>
<!-- FILE: /vote/index.html -->
