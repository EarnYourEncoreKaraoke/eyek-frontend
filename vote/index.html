<!-- EYEK /vote v2025-10-08T23:59:00Z build 7 -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Encore! • Vote</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bgDeep1:#1B0930; --bgDeep2:#16072A;
    --txt:#FFFFFF; --sub:#D8C7FF;
    --line:#6F52A8; --accent:#B692FF;
    --green:#25D366; --yellow:#F6C945; --red:#FF5E6C;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,var(--bgDeep1),var(--bgDeep2));color:var(--txt);font:17px/1.4 "Montserrat",system-ui}
  .wrap{min-height:100svh;display:flex;flex-direction:column;gap:16px;padding:22px}
  h1{margin:0;font-size:28px}
  .sub{color:var(--sub)}
  .pin{display:grid;grid-template-columns:1fr auto;gap:8px}
  input{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.25);background:#220D3F;color:#fff}
  button{padding:12px 14px;border-radius:10px;border:0;font-weight:800;cursor:pointer}
  .btnG{background:var(--green);color:#042a13}
  .btnY{background:var(--yellow);color:#352600}
  .btnR{background:var(--red);color:#2b0e12}
  .muted{color:#b8a8e8}
  .hidden{display:none}
  .foot{margin-top:auto;opacity:.85}
  .mini{font-size:12px}
  .msg{min-height:18px}
  .voteRow{display:grid;grid-template-columns:1fr;gap:10px}
  .who{border:1px dashed rgba(255,255,255,.25);padding:10px;border-radius:10px;background:#210D3F}

  /* Overlay */
  #overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);align-items:center;justify-content:center;z-index:9998}
  #ovCard{padding:20px 18px;border-radius:16px;text-align:center;border:2px solid var(--line);background:linear-gradient(180deg,#1B0930,#16072A);min-width:270px}
  #ovTitle{font-size:26px;font-weight:800}

  /* Coupon banner (bottom) */
  #couponBanner{
    position: fixed; left: 12px; right: 12px; bottom: 12px; z-index: 9999;
    display: none; gap: 10px; align-items: center;
    padding: 10px 12px; border-radius: 12px;
    background: linear-gradient(180deg, var(--bgDeep1), var(--bgDeep2));
    border: 1px solid var(--line); color: var(--txt);
    box-shadow: 0 8px 28px rgba(0,0,0,.35);
  }
  #couponBanner img{ height:44px; width:44px; object-fit:cover; border-radius:8px; border:1px solid var(--line); display:none }
  #couponBanner .txt{ font:600 14px/1.35 Montserrat, system-ui; }
  #couponBanner a{ color: var(--accent); text-decoration: none; font-weight:700; display:none }
  #couponClose{ margin-left:auto; background:#2A1352; border:1px solid var(--line); color:#fff; padding:6px 10px; border-radius:10px; cursor:pointer; }

  /* tiny visible version badge */
  .verBadge{position:fixed;bottom:6px;left:8px;font-size:11px;color:#cdbff0;opacity:.7;z-index:99999;pointer-events:none;user-select:none}
</style>
</head>
<body>
<div class="verBadge">EYEK /vote v2025-10-08 • build 7</div>

<div class="wrap">
  <header>
    <h1 id="venueTitle">Encore! Vote</h1>
    <div class="sub" id="nowSinging">&nbsp;</div>
  </header>

  <section id="unlock">
    <div class="sub">Enter Event PIN to vote</div>
    <div class="pin" style="margin-top:6px">
      <input id="pin" inputmode="numeric" autocomplete="one-time-code" placeholder="Event PIN" />
      <button id="unlockBtn" class="btnG">Unlock</button>
    </div>
    <div class="msg mini" id="unlockMsg"></div>
  </section>

  <section id="voteUI" class="hidden">
    <div class="who">
      <div class="mini muted">Voting for</div>
      <div id="singer" style="font-weight:800;font-size:20px">—</div>
    </div>

    <div class="voteRow" style="margin-top:10px">
      <button class="btnG" id="vE">Encore!</button>
      <button class="btnY" id="vA">Another Shot!</button>
      <button class="btnR" id="vM">Maybe Next Time!</button>
    </div>

    <div class="msg" id="voteMsg"></div>

    <div class="mini muted foot">
      One vote per device per singer is recorded.
    </div>
  </section>

  <!-- Overlay result -->
  <div id="overlay">
    <div id="ovCard">
      <div id="ovTitle">—</div>
      <div id="ovSub" class="sub" style="margin-top:6px">—</div>
    </div>
  </div>
</div>

<!-- Coupon banner -->
<div id="couponBanner" role="region" aria-label="Venue Coupon">
  <img id="couponImg" alt="Coupon image" />
  <div class="txt" id="couponTextOut">—</div>
  <a id="couponLinkOut" href="#" target="_blank" rel="noopener">View</a>
  <button id="couponClose" type="button">Close</button>
</div>

<script>
/* ===== Version (also at bottom) ===== */
const VER_TXT = "EYEK /vote v2025-10-08 • build 7";

/* ===== Core vote page (PHP backend) ===== */
const GET_URL = '/assets/get_state.php';
const VOTE_URL = '/assets/vote.php';

const $ = s => document.querySelector(s);
const pinEl = $('#pin'), unlockBtn = $('#unlockBtn'), unlockMsg = $('#unlockMsg');
const unlockSection = $('#unlock'), voteUI = $('#voteUI');
const singerEl = $('#singer'), venueTitle = $('#venueTitle'), nowSinging = $('#nowSinging');
const vE=$('#vE'), vA=$('#vA'), vM=$('#vM'); const voteMsg=$('#voteMsg');

let state = null, eventPin = '', currentSingerId = null, unlocked=false;
let overlayTimer = null;

function deviceId(){
  try{
    const k='eyek_device';
    let v=localStorage.getItem(k);
    if(!v){ v='d_'+Math.random().toString(36).slice(2,11); localStorage.setItem(k,v); }
    return v;
  }catch(e){ return 'na_'+Math.random().toString(36).slice(2,7); }
}

async function fetchState(){
  const r = await fetch(GET_URL, { cache:'no-store' });
  state = await r.json().catch(()=>null);
  const s = state || {};
  const e = s.event || {};
  const c = s.current || {};
  venueTitle.textContent = e.venuePublic || e.venue || 'Encore! Vote';
  nowSinging.textContent = c.name ? ('Now singing: '+c.name) : '';
  currentSingerId = c.id || null;
  singerEl.textContent = c.name || '—';
}

function setUnlocked(on){
  unlockSection.classList.toggle('hidden', on);
  voteUI.classList.toggle('hidden', !on);
  unlocked = on;
}

unlockBtn.addEventListener('click', async ()=>{
  eventPin = (pinEl.value||'').trim();
  if(!eventPin){ unlockMsg.textContent='Enter the event PIN.'; return; }
  setUnlocked(true); unlockMsg.textContent='';
  await fetchState();
});

async function sendVote(kind){
  if(!unlocked){ voteMsg.textContent='Unlock with event PIN first.'; return; }
  if(!currentSingerId){ voteMsg.textContent='No singer set yet.'; return; }

  // send many keys to satisfy different server handlers
  const body = {
    pin: eventPin, eventPin,
    singer: currentSingerId, singerId: currentSingerId,
    vote: kind, choice: kind,
    device: deviceId(), deviceId: deviceId()
  };

  try{
    const r = await fetch(VOTE_URL,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    if(!r.ok){
      let e=null; try{ e=await r.json(); }catch{}
      if(e && (e.error||'').includes('already')){ showOverlay('another','Already Voted','One vote per device per singer'); }
      else { showOverlay('maybe','Error','Please try again'); }
      return;
    }
    showOverlay(kind, kind==='encore'?'Encore! Congratulations!':(kind==='another'?'Another Shot!':'Maybe Next Time!'), 'Vote received');
    voteMsg.textContent='';
  }catch(e){
    showOverlay('maybe','Network Error','Please try again');
  }
  await fetchState();
}
vE.addEventListener('click', ()=>sendVote('encore'));
vA.addEventListener('click', ()=>sendVote('another'));
vM.addEventListener('click', ()=>sendVote('maybe'));

setInterval(fetchState, 8000);
fetchState();

function showOverlay(kind, title, sub){
  const ov = document.getElementById('overlay');
  const card = document.getElementById('ovCard');
  document.getElementById('ovTitle').textContent = title;
  document.getElementById('ovSub').textContent = sub;
  card.className = 'ovCard ' + (kind==='encore'?'ov-enc':kind==='another'?'ov-ano':'ov-may');
  ov.style.display = 'flex';
  clearTimeout(overlayTimer);
  overlayTimer = setTimeout(()=>{ ov.style.display = 'none'; }, 15000);
}
</script>

<!-- Firebase config (must exist at site root) -->
<script src="/firebase-config.js"></script>

<!-- Audience coupon: read Firestore after PIN unlock; resolve Storage path to URL when needed -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
import { getFirestore, doc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';
import { getStorage, ref, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js';

const cfg = window.firebaseConfig;
let app=null, auth=null, db=null, st=null;

if (cfg) {
  app = initializeApp(cfg);
  auth = getAuth(app);
  db   = getFirestore(app);
  st   = getStorage(app);
  signInAnonymously(auth).catch(()=>{});
}

const banner   = document.getElementById('couponBanner');
const imgEl    = document.getElementById('couponImg');
const textEl   = document.getElementById('couponTextOut');
const linkEl   = document.getElementById('couponLinkOut');
const closeBtn = document.getElementById('couponClose');
let dismissed = false;

function isExpired(iso){ if(!iso) return false; const t=Date.parse(iso); return isNaN(t)?false:(Date.now()>t); }

// Resolve URL from either direct URL field or a Storage path
async function resolveImageUrl(data){
  const direct =
    data?.couponImageUrl ||
    data?.couponImageURL ||
    data?.imageUrl ||
    data?.imageURL || '';
  if (direct) return direct;

  const path = data?.couponImagePath || data?.imagePath || '';
  if (!path || !st) return '';
  try { return await getDownloadURL(ref(st, path)); }
  catch { return ''; }
}

imgEl.addEventListener('load',  ()=>{ imgEl.style.display='block'; });
imgEl.addEventListener('error', ()=>{ imgEl.style.display='none'; });

async function renderCoupon(data){
  const exp = data?.expiresAtISO || data?.expiresAt || '';
  if (!data || !data.couponText || isExpired(exp) || dismissed) {
    banner.style.display='none'; return;
  }
  textEl.textContent = data.couponText || '';
  const url = await resolveImageUrl(data);
  if (url) { imgEl.src = url; } else { imgEl.style.display='none'; imgEl.removeAttribute('src'); }
  if (data.couponLink) { linkEl.href=data.couponLink; linkEl.style.display='inline'; }
  else { linkEl.style.display='none'; }
  banner.style.display='flex';
}

closeBtn.addEventListener('click', ()=>{ dismissed = true; banner.style.display='none'; });

// Start listening when user unlocks with PIN
(function attachAfterUnlock(){
  const unlockBtn = document.getElementById('unlockBtn');
  const pinInput  = document.getElementById('pin');
  if(!db || !unlockBtn || !pinInput) return;
  unlockBtn.addEventListener('click', ()=>{
    const pin = (pinInput.value||'').trim();
    if(!pin) return;
    const refDoc = doc(db,'events',String(pin),'promo','coupon');
    onSnapshot(refDoc, async (ss)=>{ await renderCoupon(ss.exists()?ss.data():null); }, ()=>{});
  });
})();
</script>

<!-- EYEK /vote v2025-10-08T23:59:00Z build 7 -->
</body>
</html>
