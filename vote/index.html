<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Encore! • Vote</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bgDeep1:#1B0930; --bgDeep2:#16072A;
    --txt:#fff; --sub:#d8c7ff;
    --green:#25d366; --yellow:#f6c945; --red:#ff5e6c;
    --line:#6f52a8;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,var(--bgDeep1),var(--bgDeep2));color:var(--txt);font:17px/1.4 "Montserrat",system-ui}
  .wrap{min-height:100svh;display:flex;flex-direction:column;gap:16px;padding:22px}
  h1{margin:0;font-size:28px}
  .sub{color:var(--sub)}
  .pin{display:grid;grid-template-columns:1fr auto;gap:8px}
  input{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.25);background:#220d3f;color:#fff}
  button{padding:12px 14px;border-radius:10px;border:0;font-weight:800;cursor:pointer}
  .row{display:grid;grid-template-columns:1fr;gap:10px}
  .btnG{background:var(--green);color:#042a13}
  .btnY{background:var(--yellow);color:#352600}
  .btnR{background:var(--red);color:#2b0e12}
  .tally{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
  .chip{padding:10px 18px;border-radius:999px;border:2px solid rgba(255,255,255,.15);font-weight:900}
  .enc{background:var(--green);color:#072a14}
  .ano{background:var(--yellow);color:#352600}
  .may{background:var(--red);color:#2b0e12}
  .center{text-align:center}
  .promo{margin-top:auto;border-top:1px solid var(--line);padding-top:14px}
  .promoRow{display:grid;grid-template-columns:96px 1fr;gap:12px;align-items:center}
  .promoImg{width:96px;height:96px;object-fit:cover;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:#120a22}

  /* result overlay – only shown AFTER a round ends and gate is hidden */
  .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.8);z-index:50}
  .ovCard{width:min(800px,92vw);text-align:center;border:3px solid rgba(255,255,255,.18);border-radius:22px;padding:26px}
  .ovTitle{font-size:64px;margin:0}
  .ovSub{font-size:24px;margin:10px 0 0}
  .ov-enc{background:rgba(37,211,102,.08); border-color: rgba(37,211,102,.55)}
  .ov-ano{background:rgba(246,201,69,.08); border-color: rgba(246,201,69,.55)}
  .ov-may{background:rgba(255,94,108,.08); border-color: rgba(255,94,108,.55)}
</style>
</head>
<body>
<div class="wrap">
  <div class="center">
    <h1 id="venue">—</h1>
    <div class="sub" id="now">—</div>
    <div class="sub" id="forSinger" style="margin-top:6px">—</div>
  </div>

  <div id="gate">
    <div class="sub">Enter event PIN to vote</div>
    <div class="pin" style="margin-top:8px">
      <input id="pin" inputmode="numeric" placeholder="PIN">
      <button id="unlock">Unlock</button>
    </div>
    <div id="msg" class="sub" style="margin-top:6px"></div>
  </div>

  <div id="vote" style="display:none">
    <div class="row">
      <button id="vE" class="btnG">Encore!</button>
      <button id="vA" class="btnY">Another Shot!</button>
      <button id="vM" class="btnR">Maybe Next Time!</button>
    </div>
    <div class="tally" style="margin-top:12px">
      <div class="chip enc">Encore! <b id="cE">0</b></div>
      <div class="chip ano">Another Shot! <b id="cA">0</b></div>
      <div class="chip may">Maybe Next Time! <b id="cM">0</b></div>
    </div>

    <!-- promo / coupon -->
    <div class="promo" id="promo" style="display:none">
      <div class="promoRow">
        <img id="promoImg" class="promoImg" alt="promo" />
        <div>
          <div id="promoText" class="sub"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- results overlay -->
<div id="overlay" class="overlay" aria-hidden="true">
  <div id="ovCard" class="ovCard">
    <div id="ovTitle" class="ovTitle">Encore!</div>
    <p id="ovSub" class="ovSub">Congratulations, —</p>
  </div>
</div>

<script>
const GET_URL='/assets/get_state.php';
const VOTE_URL='/assets/vote.php';
const $=s=>document.querySelector(s);
let state=null, clockOffset=0;
let overlayTimer=null, lastResultShownToken=null;
let unlocked=false; // gate state

function nowMs(){return Date.now()+clockOffset}
function smoothOffset(o){ if(!isFinite(o)) return; clockOffset=0.9*clockOffset+0.1*o; }
function deviceId(){ let id=localStorage.getItem('eyek_device_id'); if(!id){ id=crypto.randomUUID(); localStorage.setItem('eyek_device_id', id);} return id; }

async function fetchState(){
  const r=await fetch(GET_URL,{cache:'no-store'}); const fetchedAt=Date.now(); state=await r.json();
  if(state && typeof state.serverNow==='number'){ smoothOffset(state.serverNow - fetchedAt); }
  render();
}
setInterval(fetchState,1000); fetchState();

function render(){
  const venuePublic = (state?.event?.venuePublic||'—');
  $('#venue').textContent = venuePublic;

  const open = !!state?.voting?.open;
  const t=nowMs(); const prep = (!open && (state?.voting?.prepUntil||0) > t);
  const name = (state?.current?.name||'').trim();
  const endsAt = state?.voting?.endsAt||0;

  $('#forSinger').textContent = name ? `Voting for: ${name}` : '—';
  $('#now').textContent = prep ? (name?`Get ready to vote for: ${name}`:'Get ready to vote…')
                      : open ? (name?`Now voting for: ${name}`:'Now voting!')
                      : '—';

  // gate logic: only show vote UI if unlocked AND (prep or open)
  const showVoteUI = unlocked && (open || prep);
  $('#gate').style.display = showVoteUI ? 'none' : 'block';
  $('#vote').style.display = showVoteUI ? 'block' : 'none';

  // counts
  $('#cE').textContent = state?.voting?.counts?.encore||0;
  $('#cA').textContent = state?.voting?.counts?.another||0;
  $('#cM').textContent = state?.voting?.counts?.maybe||0;

  // promo
  const haveAd = (state?.event?.ad?.imageUrl || state?.event?.ad?.text);
  if(haveAd && showVoteUI){
    $('#promo').style.display='block';
    const u = (state.event.ad.imageUrl||'').trim();
    if(u){ $('#promoImg').src=u; $('#promoImg').style.display='block'; } else { $('#promoImg').style.display='none'; }
    $('#promoText').textContent = (state.event.ad.text||'').trim();
  }else{
    $('#promo').style.display='none';
  }

  // result overlay:
  // ONLY show after round is finished (no prep, no open), and only if gate is not on the PIN screen (we hide overlay when gate is visible)
  const gateVisible = !showVoteUI;
  if(!open && !prep && !gateVisible && state?.voting?.lastResult){
    const kind=state.voting.lastResult;
    const token = `${kind}|${name}`;
    if(token!==lastResultShownToken){
      const title = kind==='encore'?'Encore!':(kind==='another'?'Another Shot!':'Maybe Next Time!');
      const nm = (name||'').replace(/\.\s*$/,'') || '';
      const sub = kind==='maybe' ? (nm?`Thanks, ${nm}!`:'Thanks for singing!')
                                 : (nm?`Congratulations, ${nm}!`:'Congratulations!');
      showOverlay(kind, title, sub);
      lastResultShownToken=token;
    }
  } else {
    // while gate is visible or vote is open, keep overlay hidden
    hideOverlay();
  }

  // auto-clear counts client-side display if a new singer is set
  // (server already resets, but this protects against stale ui)
  if(!open && !prep && (endsAt===0)){
    // nothing extra; server state drives the zeros
  }
}

// PIN unlock
$('#unlock').onclick = async ()=>{
  const pin = $('#pin').value.trim();
  const ok = pin && pin === (state?.event?.pin||'');
  $('#msg').textContent = ok ? 'Unlocked.' : 'Wrong PIN.';
  if(ok){
    unlocked = true;
    $('#gate').style.display='none';
    $('#vote').style.display='block';
  }
};

// send vote
async function send(choice){
  if(!(state?.voting?.open) || !unlocked) return;
  const res=await fetch(VOTE_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({choice,deviceId:deviceId()})});
  if(!res.ok){
    const e=await res.json().catch(()=>({error:'vote_failed'}));
    if(e.error==='already_voted'){ alert('You already voted this round.'); }
  }
}
$('#vE').onclick=()=>send('encore'); $('#vA').onclick=()=>send('another'); $('#vM').onclick=()=>send('maybe');

// overlay helpers
function showOverlay(kind, title, sub){
  const ov=$('#overlay'), card=$('#ovCard');
  document.getElementById('ovTitle').textContent=title;
  document.getElementById('ovSub').textContent=sub;
  card.className='ovCard '+(kind==='encore'?'ov-enc':kind==='another'?'ov-ano':'ov-may');
  ov.style.display='flex';
  clearTimeout(overlayTimer);
  overlayTimer=setTimeout(()=>{ ov.style.display='none'; }, 15000);
}
function hideOverlay(){ const ov=$('#overlay'); if(ov.style.display!=='none') ov.style.display='none'; }
</script>
</body>
</html>
<!-- FILE: /vote/index.html -->
