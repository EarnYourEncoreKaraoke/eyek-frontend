<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Encore! • Board</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Hourly auto-refresh as a last resort to “wake” Silk -->
<meta http-equiv="refresh" content="3600">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:wght@700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#2F0658;
    --deep1:#1B0930; --deep2:#16072A;
    --txt:#fff; --muted:#d8c7ff;
    --green:#25d366; --yellow:#f6c945;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font:18px/1.35 "Montserrat",system-ui}
  .wrap{min-height:100svh;display:grid;grid-template-columns:1fr 1fr;gap:24px;padding:24px}
  .col{
    border:2px solid rgba(255,255,255,.15);border-radius:16px;padding:16px;
    display:flex;flex-direction:column;min-height:calc(100svh - 48px);
    background:linear-gradient(180deg,var(--deep1),var(--deep2))
  }
  /* Smaller, responsive headings */
  .title{font-family:"Bebas Neue";font-size:clamp(36px,6vw,64px);text-align:center;margin:6px 0 10px}
  .enc{color:var(--green); text-shadow:0 0 24px rgba(37,211,102,.35)}
  .ano{color:var(--yellow); text-shadow:0 0 24px rgba(246,201,69,.35)}

  /* More rows visible */
  .list{flex:1;display:flex;flex-direction:column;gap:10px;overflow:auto;scrollbar-width:thin}
  .row{
    font-size:clamp(18px,2.2vw,28px);
    padding:8px 12px;border-radius:10px;
    background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1)
  }
  .song{font-size:0.6em;color:var(--muted);margin-left:8px}

  /* Off-screen heartbeat pixel */
  #heartbeat{position:fixed;width:1px;height:1px;left:-10px;top:-10px;background:transparent}
</style>
</head>
<body>
<div id="heartbeat" aria-hidden="true"></div>

<div class="wrap">
  <section class="col">
    <h1 class="title enc">Encore!</h1>
    <div id="encList" class="list"></div>
  </section>
  <section class="col">
    <h1 class="title ano">Another Shot!</h1>
    <div id="anoList" class="list"></div>
  </section>
</div>

<script>
/* --- CONFIG / ENDPOINTS --- */
const GET_URL='/assets/get_state.php';
const $=s=>document.querySelector(s);

/* --- Wake Lock (where supported) --- */
let wakeLock=null;
async function requestWakeLock(){ try{ if('wakeLock' in navigator){ wakeLock=await navigator.wakeLock.request('screen'); } }catch(e){} }
document.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='visible') requestWakeLock(); });
window.addEventListener('focus', requestWakeLock);
requestWakeLock();

/* --- “Don’t sleep” helpers for Silk/TVs --- */
/* 1) Constant tiny DOM change via requestAnimationFrame */
(function heartbeatRAF(){
  const hb = $('#heartbeat');
  let i = 0;
  function tick(){
    // toggle a style each frame to indicate activity
    hb.style.transform = (i++ % 2) ? 'translateX(1px)' : 'translateX(0)';
    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
})();

/* 2) Title spinner — keeps activity even if tab is backgrounded */
(function spinningTitle(){
  const base = 'Encore! • Board';
  const frames = ['·','•','●','•'];
  let idx = 0;
  setInterval(()=>{ document.title = base + ' ' + frames[idx++ % frames.length]; }, 2000);
})();

/* 3) Periodic no-op audio context “ping” (safe if blocked) */
let ac=null;
setInterval(()=>{
  try{
    if(!ac){ ac = new (window.AudioContext||window.webkitAudioContext)(); }
    const o = ac.createOscillator(), g = ac.createGain();
    g.gain.value = 0.00001; o.connect(g).connect(ac.destination);
    o.start(); o.stop(ac.currentTime+0.02);
  }catch(e){/* ignore if blocked */}
}, 30000);

/* --- State fetch + render --- */
function parseWhen(w){ const t=Date.parse(w||''); return isNaN(t)?0:t; }

async function fetchState(){
  try{
    const r=await fetch(GET_URL,{cache:'no-store'});
    const st=await r.json();

    const enc = st?.winners?.encore || [];
    const ano = st?.winners?.another || [];
    const may = st?.winners?.maybe  || []; // “maybe” removes a singer from board

    // Build latest status per singer name
    const latest = new Map(); // name -> {kind, when, song}
    function ingest(arr, kind){
      for(const it of arr){
        const name=(it?.name||'').trim(); if(!name) continue;
        const w=parseWhen(it.when); const prev=latest.get(name);
        if(!prev || w>prev.when){ latest.set(name, {kind, when:w, song:it?.song||''}); }
      }
    }
    ingest(enc,'encore'); ingest(ano,'another'); ingest(may,'maybe');

    const listEnc=[], listAno=[];
    for(const [name,info] of latest.entries()){
      if(info.kind==='maybe') continue;
      const item={name, song:info.song, when:info.when};
      if(info.kind==='encore') listEnc.push(item); else listAno.push(item);
    }
    listEnc.sort((a,b)=>b.when-a.when);
    listAno.sort((a,b)=>b.when-a.when);

    function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
    function render(listEl, arr){
      listEl.innerHTML = arr.length
        ? arr.map(it=>`<div class="row">${escapeHtml(it.name)}<span class="song">${escapeHtml(it.song||'')}</span></div>`).join('')
        : '<div class="row" style="opacity:.5">—</div>';
    }
    render($('#encList'), listEnc);
    render($('#anoList'), listAno);
  }catch(e){/* ignore transient errors */}
}
setInterval(fetchState, 2000);
fetchState();
</script>
</body>
</html>
