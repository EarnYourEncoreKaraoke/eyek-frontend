<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Encore! • Host</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bgDeep1:#1B0930; --bgDeep2:#16072A;
    --card:#1b0930; --card2:#16072a; --line:#6f52a8; --txt:#eef3ff; --muted:#cdbff0; --accent:#b692ff;
    --green:#25d366; --yellow:#f6c945; --red:#ff5e6c; --ink:#1a1030;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,var(--bgDeep1),var(--bgDeep2));color:var(--txt);font:15px/1.45 "Montserrat",system-ui}
  .page{min-height:100svh;display:grid;grid-template-columns:320px 1fr 300px;gap:16px;padding:18px}
  @media (max-width:1100px){ .page{grid-template-columns:1fr; padding:12px} }
  a{color:var(--accent);text-decoration:none}
  h1{font-size:22px;margin:0 0 8px}
  h2{font-size:18px;margin:0 0 10px}
  .card{background:linear-gradient(180deg,var(--card),var(--card2)); border:1px solid #5b3d87; border-radius:16px; overflow:hidden}
  .card > h2, .card > summary{padding:12px 14px;background:rgba(255,255,255,.04);border-bottom:1px solid #5b3d87}
  .card .body{padding:12px 14px}
  .tiny{font-size:12px;color:var(--muted)}
  input,select,button{font:inherit}
  input, select{width:100%; padding:10px 12px; border-radius:10px; border:1px solid #5b3d87; background:#200d3c; color:#fff; outline:none}
  input[disabled]{opacity:.6}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .row-60-40{display:grid; grid-template-columns:3fr 2fr; gap:12px}
  @media (max-width:900px){ .row, .row-60-40{grid-template-columns:1fr} }
  .btn{appearance:none; border:1px solid #5b3d87; background:#2a1352; color:#fff; padding:10px 12px; border-radius:12px; cursor:pointer}
  .btn[disabled]{opacity:.6; cursor:not-allowed}
  .btn.pri{background:#4e2aa3; border-color:#7b61c6}
  .btn.warn{background:#3b0f19; border-color:#b65a5a}
  .btn.start{background:var(--green); border-color:var(--green); color:#093d21; font-weight:800}
  .btn.extend{background:var(--yellow);border-color:var(--yellow);color:#3a2c00;font-weight:800}
  .btn.end{background:var(--red);border-color:var(--red);color:#2b0e12;font-weight:800}
  .stack{display:flex;gap:8px;flex-wrap:wrap}
  .pill{display:flex;align-items:center;gap:8px;background:#220d3f;border:1px solid var(--line);border-radius:12px;padding:8px 10px;margin-bottom:8px}
  .dot{width:10px;height:10px;border-radius:999px;background:#999;flex:0 0 10px}
  .dot.green{background:var(--green)} .dot.yellow{background:var(--yellow)}
  .nameTag{background:#fff;color:#111;padding:4px 8px;border-radius:8px;font-weight:800;max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .kv{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .sectionTitle{font-size:18px;font-weight:900;margin:6px 0 10px}
  .divider{height:1px;background:#5b3d87;margin:10px 0;opacity:.7}
  .sublabel{font-size:12px;color:#e9dbff;margin-top:6px}
  .xl{font-size:28px}
  .currentBox{background:#220d3f;border:1px solid var(--line);border-radius:14px;padding:12px;margin-top:8px}
  .currentBox .big{font-weight:900;font-size:30px}
  .miniWhite{background:#fff;border-radius:12px;padding:8px;color:#111;font-weight:800}
  .mdots{position:relative;height:120px;border-radius:12px;background:#1c0e33;border:1px dashed #6f52a8;overflow:hidden}
  .mdot{position:absolute;width:8px;height:8px;border-radius:999px;opacity:.9;mix-blend-mode:screen}
  .mdot.g{background:var(--green)} .mdot.y{background:var(--yellow)} .mdot.r{background:var(--red)}
  .resultTag{display:inline-flex;align-items:center;gap:8px;padding:4px 10px;border-radius:999px;border:1px solid #5b3d87;background:#200d3c}
  .resultTag.g{background:rgba(37,211,102,.12);border-color:#2e9f61}
  .resultTag.y{background:rgba(246,201,69,.12);border-color:#b49334}
  .resultTag.r{background:rgba(255,94,108,.12);border-color:#a94e59}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .ghost{opacity:.6}
</style>
</head>
<body>
<div class="page">

  <!-- Left: Event & Saved -->
  <div class="col">
    <h1>Host Control</h1>

    <details class="card" id="setupPanel" open>
      <summary>Event &amp; KJ Information</summary>
      <div class="body">

        <div class="row">
          <div>
            <div class="sublabel">Venue Name</div>
            <input id="venue" list="venuesList" placeholder="Internal Venue Name" />
            <datalist id="venuesList"></datalist>
          </div>
          <div>
            <div class="sublabel">Public Venue Name</div>
            <input id="venuePublic" list="venuesPublicList" placeholder="Public Venue Name" />
            <datalist id="venuesPublicList"></datalist>
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div>
            <div class="sublabel">KJ Company</div>
            <input id="kj" list="kjsList" placeholder="Karaoke Company" />
            <datalist id="kjsList"></datalist>
          </div>
          <div>
            <div class="sublabel">KJ Host Name</div>
            <input id="hostName" placeholder="KJ Host Name" />
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div>
            <div class="sublabel">Event Date</div>
            <input id="eventDate" type="date" />
          </div>
          <div>
            <div class="sublabel">Event PIN</div>
            <div class="stack">
              <input id="pin" placeholder="1234" style="max-width:140px" />
              <button id="togglePin" class="btn">Show</button>
            </div>
            <div id="pinSaved" class="tiny" style="height:16px;margin-top:4px"></div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- ===== Coupon (optional) START ===== -->
        <div class="divider"></div>
        <div class="sectionTitle white" style="margin-top:0">Coupon (optional)</div>
        <div class="row">
          <div>
            <div class="sublabel">Coupon Text</div>
            <input id="couponText" type="text" placeholder="e.g. Free appetizer with drink" />
          </div>
          <div>
            <div class="sublabel">Coupon Link (optional)</div>
            <input id="couponLink" type="url" placeholder="https://yourvenue.com/deal" />
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div>
            <div class="sublabel">Coupon Image (optional)</div>
            <input id="couponImage" type="file" accept="image/*" />
          </div>
          <div>
            <div class="sublabel">Expires At (optional)</div>
            <input id="expiresAt" type="datetime-local" />
          </div>
        </div>

        <div class="stack" style="margin-top:10px">
          <button id="submitCoupon" class="btn pri" type="button">Submit Coupon</button>
          <div id="couponSubmitMsg" class="tiny"></div>
        </div>
        <!-- ===== Coupon (optional) END ===== -->

        <div class="stack" style="margin-top:10px">
          <button id="saveEvent" class="btn pri">Save</button>
          <button id="lockEvent" class="btn">Lock</button>
          <button id="resetEvent" class="btn warn">Reset</button>
          <div id="eventSavedMsg" class="tiny"></div>
        </div>
      </div>
    </details>

    <div class="card" style="margin-top:16px">
      <h2>Singer Control</h2>
      <div class="body">
        <div class="row-60-40">
          <div>
            <div class="currentBox">
              <div class="sectionTitle" style="margin-top:0">Add Singer</div>
              <div class="row" style="grid-template-columns:1fr 1fr">
                <div>
                  <div class="sublabel">Singer Name</div>
                  <input id="singerName" placeholder="Name" />
                </div>
                <div>
                  <div class="sublabel">Song / Artist</div>
                  <input id="songArtist" placeholder="(optional)" />
                </div>
              </div>
              <div class="stack" style="margin-top:8px">
                <button id="addSinger" class="btn pri">Add</button>
              </div>

              <div class="divider"></div>
              <div class="sectionTitle" style="margin-top:0">Current</div>
              <div class="kv">
                <div>
                  <div class="sublabel">Name</div>
                  <div id="currentName" class="big">—</div>
                </div>
                <div>
                  <div class="sublabel">Song / Artist</div>
                  <input id="currentSongArtist" placeholder="(optional)" />
                </div>
              </div>
            </div>

            <div class="sectionTitle" style="margin-top:12px">Singer Rotation</div>
            <div id="singerList"></div>
          </div>

          <div>
            <div class="sectionTitle" style="margin-top:0">Mini Vote Particles</div>
            <div class="mdots" id="miniDots"></div>
            <div class="tiny" style="margin-top:6px">Shows lightweight falling dots for each incoming vote.</div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Middle: Voting Control -->
  <div class="col">
    <div class="card">
      <h2>Voting</h2>
      <div class="body">
        <div class="grid2">
          <div>
            <div class="sectionTitle" style="margin-top:0">Timer</div>
            <div class="xl" id="timer">00:00</div>
            <div class="tiny" id="votingStatus" style="height:16px"></div>

            <div class="divider"></div>
            <div class="sectionTitle" style="margin-top:0">Tally (Live)</div>
            <div class="kv">
              <div>
                <div class="sublabel">Encore!</div>
                <div id="countEncore" class="big">0</div>
              </div>
              <div>
                <div class="sublabel">Another Shot!</div>
                <div id="countAnother" class="big">0</div>
              </div>
              <div>
                <div class="sublabel">Maybe Next Time!</div>
                <div id="countMaybe" class="big">0</div>
              </div>
            </div>
          </div>

          <div>
            <div class="sectionTitle" style="margin-top:0">Result</div>
            <div id="resultTag" class="resultTag">—</div>

            <div class="divider"></div>
            <div class="sectionTitle" style="margin-top:0">Controls</div>
            <div class="stack">
              <button id="start" class="btn start">Start</button>
              <button id="extend" class="btn extend">Extend</button>
              <button id="end" class="btn end">End</button>
            </div>

            <div class="divider"></div>
            <div class="sectionTitle" style="margin-top:0">Sound</div>
            <div class="stack">
              <button id="enableSound" class="btn">Enable Sound</button>
              <div class="tiny" id="soundStatus">Sound: <b>off</b></div>
              <div class="tiny" id="loopStatus" style="margin-left:10px">Loop: <b>stopped</b></div>
            </div>
          </div>
        </div>

        <div class="divider"></div>
        <div class="sectionTitle" style="margin-top:0">Quick Host Vote</div>
        <div class="stack">
          <button data-vote="encore"  class="btn" style="background:var(--green);border-color:var(--green);color:#0b3f22;font-weight:800">Encore!</button>
          <button data-vote="another" class="btn" style="background:var(--yellow);border-color:var(--yellow);color:#3a2c00;font-weight:800">Another Shot!</button>
          <button data-vote="maybe"   class="btn" style="background:var(--red);border-color:var(--red);color:#2b0e12;font-weight:800">Maybe Next Time!</button>
        </div>

      </div>
    </div>
  </div>

  <!-- Right: Winners / Feed -->
  <div class="col">
    <div class="card">
      <h2>Round Feed</h2>
      <div class="body">
        <div class="stack tiny" style="align-items:center;justify-content:space-between">
          <div id="eventTitle"></div>
          <div id="nowTs"></div>
        </div>

        <div class="divider"></div>

        <div class="sectionTitle" style="margin-top:0">Last Votes</div>
        <div id="lastVotes" class="tiny"></div>

        <div class="divider"></div>

        <div class="sectionTitle" style="margin-top:0">Winners</div>
        <div class="kv">
          <div>
            <div class="sublabel">Encore!</div>
            <div id="wEncore" class="miniWhite" style="min-height:28px"></div>
          </div>
          <div>
            <div class="sublabel">Another Shot!</div>
            <div id="wAnother" class="miniWhite" style="min-height:28px"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

</div>

<script>
const GET_URL  = '/assets/get_state.php';
const POST_URL = '/assets/state.php';
const VOTE_URL = '/assets/vote.php';
const PERF_URL = '/assets/submit_performance.php';

let state = null;
let setupPeekUntil = 0;
const RECENT_MS = 2500;

const $ = sel => document.querySelector(sel);
const nowMs = ()=> Date.now();
const fmt = ms => {
  const s = Math.max(0, Math.round(ms/1000));
  const m = (s/60|0)+'';
  const z = (s%60+'').padStart(2,'0');
  return `${m}:${z}`;
};
function markEdit(id){ recentEdit[id]=Date.now(); }
const recentEdit = {};
function canUpdateField(el, id){ if(document.activeElement === el) return false; if((recentEdit[id]||0) > Date.now()-RECENT_MS) return false; return true; }
let pollPaused=false, resumeTimer=null;
function pausePolling(){ pollPaused=true; clearTimeout(resumeTimer); }
function resumePollingSoon(){ clearTimeout(resumeTimer); resumeTimer=setTimeout(()=>pollPaused=false, 1000); }

const setupPanel = document.getElementById('setupPanel');
setupPanel.addEventListener('toggle', ()=>{
  if(setupPanel.open && !state?.event?.locked){
    setupPeekUntil = Date.now() + 30000; // 30s grace
  }
});
setupPanel.querySelector('summary').addEventListener('click', ()=>{
  if (state?.event?.locked){
    setupPeekUntil = Date.now() + 30000;
  }
});

const venue=$('#venue'), venuePublic=$('#venuePublic'), eventDate=$('#eventDate'), kj=$('#kj'), hostName=$('#hostName'), pin=$('#pin');
const venuesList=document.getElementById('venuesList'), kjsList=document.getElementById('kjsList');
const singerName=$('#singerName'), songArtist=$('#songArtist');
const singerList=$('#singerList');
const currentName=$('#currentName'), currentSongArtist=$('#currentSongArtist');
const cE=$('#countEncore'), cA=$('#countAnother'), cM=$('#countMaybe');
const timerEl=$('#timer'), resultTag=$('#resultTag');
const eventTitle=$('#eventTitle'), nowTs=$('#nowTs');
const lastVotes=$('#lastVotes');
const wEncore=$('#wEncore'), wAnother=$('#wAnother');

const togglePin=$('#togglePin');

const watchInputs=[venue,venuePublic,eventDate,kj,hostName,pin,document.getElementById('couponText'),document.getElementById('couponLink'),document.getElementById('expiresAt')].filter(Boolean);
watchInputs.forEach(el=>{
  el.addEventListener('focusin', ()=>{ pausePolling(); markEdit(el.id); });
  el.addEventListener('focusout', resumePollingSoon);
  el.addEventListener('input', ()=>{ markEdit(el.id); pausePolling(); });
});

/* Mini-ball spawner */
function spawnMini(containerSel, kind, n=1){
  const box=document.querySelector(containerSel); if(!box) return;
  const cls = kind==='encore'?'g':kind==='another'?'y':'r';
  const W=box.clientWidth, H=box.clientHeight;
  for(let i=0;i<n;i++){
    const d=document.createElement('div'); d.className='mdot '+cls;
    d.style.left=(Math.random()*W|0)+'px'; d.style.top='-8px';
    box.appendChild(d);
    let x=parseFloat(d.style.left), y=-8, vx=(Math.random()*1.6-0.8), vy=(Math.random()*1.2+0.6);
    const g=0.25, fr=0.82, dt=16;
    const id=setInterval(()=>{
      vy+=g; x+=vx*dt/16; y+=vy*dt/16;
      if(x<8){x=8;vx*=-fr} if(x>W-8){x=W-8;vx*=-fr}
      if(y>H-8){y=H-8; vy*=-fr; if(Math.abs(vy)<0.25){clearInterval(id);} }
      d.style.left=x+'px'; d.style.top=y+'px';
    }, dt);
    if(box.childNodes.length>120){ box.removeChild(box.firstChild); }
  }
}

let lastCounts = { encore:0, another:0, maybe:0 };

let clockOffset = 0;
function smoothOffset(obs){
  // EMA adjust
  clockOffset = clockOffset*0.9 + obs*0.1;
}

async function fetchState(){
  const r=await fetch(GET_URL,{cache:'no-store'});
  const serverFetchedAt = Date.now();
  state=await r.json();
  if(state && typeof state.serverNow === 'number'){
    const observed = state.serverNow - serverFetchedAt;
    if(clockOffset === 0) clockOffset = observed; else smoothOffset(observed);
  }
  // seed defaults
  state.event   ||= {venue:'',venuePublic:'',date:new Date().toISOString().slice(0,10),kj:'',hostName:'',pin:'',locked:false, coupon:{couponText:'',couponLink:'',couponImageUrl:'',expiresAt:''}};
  if(!state.event.coupon) state.event.coupon = {couponText:'',couponLink:'',couponImageUrl:'',expiresAt:''};
  state.saved   ||= {venues:[], venuesPublic:[], kjs:[]};
  state.singers ||= []; state.current ||= {id:null,name:'',songArtist:''};
  state.voting  ||= {open:false,prepUntil:0,endsAt:0,extendCount:0,counts:{encore:0,another:0,maybe:0},lastResult:null,voters:{}};
  state.winners ||= {encore:[], another:[], maybe:[]};

  // paint setup fields (with edit guards)
  const canPaint = !state.event.locked;
  if (canPaint && canUpdateField(venue,'venue'))               venue.value       = state.event.venue || '';
  if (canPaint && canUpdateField(venuePublic,'venuePublic'))   venuePublic.value = state.event.venuePublic || '';
  if (canPaint && canUpdateField(eventDate,'eventDate'))       eventDate.value   = state.event.date || '';
  if (canPaint && canUpdateField(kj,'kj'))                     kj.value          = state.event.kj || '';
  if (canPaint && canUpdateField(hostName,'hostName'))         hostName.value    = state.event.hostName || '';
  if (canPaint && canUpdateField(pin,'pin'))                   pin.value         = state.event.pin || '';

  const disabled = !!state.event.locked;
  [venue,venuePublic,eventDate,kj,hostName,pin,document.getElementById('couponText'),document.getElementById('couponLink'),document.getElementById('expiresAt'),document.getElementById('couponImage')].filter(Boolean).forEach(el=>el.disabled=disabled);

  // KEEP OPEN if unlocked 
  const sum = setupPanel.querySelector('summary');
  if(!state.event.locked){
    const wantOpen = Date.now() < setupPeekUntil;
    if(wantOpen) setupPanel.open = true;
    sum.classList.toggle('ghost', !wantOpen);
  } else {
    sum.classList.add('ghost');
  }

  // rotation list
  singerList.innerHTML='';
  (state.singers||[]).forEach(s=>{
    const row=document.createElement('div'); row.className='pill';
    const dot=document.createElement('div'); dot.className='dot '+(s._color||'');
    const name=document.createElement('div'); name.className='nameTag'; name.textContent=s.name;
    const actions=document.createElement('div'); actions.style.display='flex'; actions.style.gap='6px';
    const setB=document.createElement('button'); setB.className='btn pri'; setB.textContent='Set'; setB.onclick=()=>setCurrent(s.id);
    const rmB=document.createElement('button'); rmB.className='btn warn'; rmB.textContent='Remove'; rmB.onclick=()=>removeSinger(s.id);
    actions.append(setB,rmB); row.append(dot,name,actions); singerList.append(row);
  });

  currentName.textContent=state.current.name||'—';
  currentSongArtist.disabled=!state.current.id;
  if(canUpdateField(currentSongArtist,'currentSongArtist')) currentSongArtist.value=state.current.songArtist||'';

  const ce=state.voting.counts.encore||0, ca=state.voting.counts.another||0, cm=state.voting.counts.maybe||0;
  cE.textContent=ce; cA.textContent=ca; cM.textContent=cm;

  const tNow = nowMs();
  if(!state.voting.open && (state.voting.prepUntil||0) > tNow){
    const ms = state.voting.prepUntil - tNow;
    timerEl.textContent = 'Get ready: '+fmt(ms);
    resultTag.textContent='—'; resultTag.className='resultTag';
  } else if(state.voting.open){
    const ms=Math.max(0, (state.voting.endsAt||0)-tNow);
    timerEl.textContent=fmt(ms);
    resultTag.textContent='Voting…'; resultTag.className='resultTag';
  } else {
    timerEl.textContent='00:00'; announce(state.voting.lastResult);
  }

  // Title & now
  eventTitle.textContent = (state.event.venuePublic||state.event.venue||'') + (state.current?.name? ' • Now: '+state.current.name : '');
  nowTs.textContent = new Date().toLocaleTimeString();

  // Winners
  wEncore.textContent = (state.winners.encore||[]).join(', ');
  wAnother.textContent = (state.winners.another||[]).join(', ');

  // mini dots for deltas
  const dE = Math.max(0, ce-lastCounts.encore), dA=Math.max(0, ca-lastCounts.another), dM=Math.max(0, cm-lastCounts.maybe);
  if(dE) spawnMini('#miniDots','encore', dE);
  if(dA) spawnMini('#miniDots','another', dA);
  if(dM) spawnMini('#miniDots','maybe', dM);
  lastCounts = {encore:ce, another:ca, maybe:cm};
}

function deviceId(){
  const k='eyek_device'; try{
    let v=localStorage.getItem(k);
    if(!v){ v='d_'+Math.random().toString(36).slice(2,11); localStorage.setItem(k,v); }
    return v;
  }catch(e){ return 'na_'+Math.random().toString(36).slice(2,7); }
}

function bindLive(el, path){
  if(!el) return;
  el.addEventListener('input', async ()=>{
    if(state?.event?.locked){ return; }
    const keys = path.split('.');
    let obj = state; for(let i=0;i<keys.length-1;i++){ const k=keys[i]; obj = obj[k] ||= {}; }
    obj[keys.at(-1)] = el.value;
    markEdit(el.id);
    await postState();
  });
}
bindLive(venue,       'venue');
bindLive(venuePublic, 'venuePublic');
bindLive(eventDate,   'date');
bindLive(kj,          'kj');
bindLive(hostName,    'hostName');
bindLive(pin,         'pin');
// promo removed

document.getElementById('saveEvent').onclick = async ()=>{
  pushLocalList('venue', venue.value);
  pushLocalList('venuePublic', venuePublic.value);
  pushLocalList('kj', kj.value);
  await postState(); const m=document.getElementById('eventSavedMsg'); m.textContent='Saved!'; setTimeout(()=>m.textContent='',1400);
};
document.getElementById('lockEvent').onclick = async ()=>{
  state.event.locked = !state.event.locked;
  await postState();
};
document.getElementById('resetEvent').onclick = async ()=>{
  if(state.event.locked){ alert('Unlock to reset.'); return;}
  if(!confirm('Reset this event? This clears singers & votes.')) return;
  state={ serverUpdatedAt: Date.now()/1000|0,
    event:{venue:'',venuePublic:'',date:new Date().toISOString().slice(0,10),kj:'',hostName:'',pin:'',locked:false, coupon:{couponText:'',couponLink:'',couponImageUrl:'',expiresAt:''}},
    saved:{venues: state.saved?.venues ?? [], kjs: state.saved?.kjs ?? [], venuesPublic: state.saved?.venuesPublic ?? []},
    singers:[], current:{id:null,name:'',songArtist:''},
    voting:{open:false,prepUntil:0,endsAt:0,extendCount:0,counts:{encore:0,another:0,maybe:0},lastResult:null,voters:{}},
    winners:{encore:[], another:[], maybe:[]}
  };
  await postState();
};

// Coupon submit (placeholder; Firebase integration pending)
(function(){
  const btn = document.getElementById('submitCoupon');
  if(!btn) return;
  const msg = document.getElementById('couponSubmitMsg');
  const $ = (id)=>document.getElementById(id);
  btn.addEventListener('click', async ()=>{
    const couponText = $('couponText')?.value?.trim() || '';
    const couponLink = $('couponLink')?.value?.trim() || '';
    const expiresAt  = $('expiresAt')?.value || '';
    const file       = $('couponImage')?.files?.[0] || null;
    if(!couponText){ msg.textContent='Please enter Coupon Text (link/image optional).'; return; }
    // Save into state.event.coupon (image upload will be added with Firebase Storage)
    state.event.coupon = Object.assign({}, state.event.coupon||{}, {
      couponText, couponLink, expiresAt
    });
    await postState();
    msg.textContent='Coupon saved (image upload pending Firebase).';
    setTimeout(()=>{ msg.textContent=''; }, 3000);
  });
})();

/* ---- Singer ops ---- */
function pushLocalList(kind, val){
  if(!val) return;
  const key = 'eyek_'+kind+'s';
  try{
    const list = JSON.parse(localStorage.getItem(key)||'[]');
    if(!list.includes(val)) list.unshift(val);
    localStorage.setItem(key, JSON.stringify(list.slice(0,15)));
  }catch(e){}
}
function pullLocalList(kind){
  try{
    return JSON.parse(localStorage.getItem('eyek_'+kind+'s')||'[]');
  }catch(e){ return []; }
}

document.addEventListener('DOMContentLoaded', ()=>{
  const v = pullLocalList('venue'); venuesList.innerHTML = v.map(s=>`<option value="${s}">`).join('');
  const vp = pullLocalList('venuePublic'); document.getElementById('venuesPublicList').innerHTML = vp.map(s=>`<option value="${s}">`).join('');
  const k = pullLocalList('kj'); kjsList.innerHTML = k.map(s=>`<option value="${s}">`).join('');
});

document.getElementById('addSinger').onclick = async ()=>{
  const name=singerName.value.trim(); if(!name){ alert('Enter a singer name.'); return;}
  const id='s_'+Math.random().toString(36).slice(2,9);
  state.singers.push({id,name,_color:''});
  singerName.value=''; songArtist.value='';
  await postState();
};
async function logPerformance(action){
  try{ await fetch(PERF_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action, ts:Date.now(), current:state.current?.name||'',song:state.current?.songArtist||''})}); }catch(e){}
}
function setCurrent(id){
  const s = state.singers.find(x=>x.id===id); if(!s) return;
  // FULL reset for the new round
  state.voting = { open:false, prepUntil:0, endsAt:0, extendCount:0,
                   counts:{encore:0,another:0,maybe:0}, lastResult:null, voters:{} };
  lastCounts = {encore:0,another:0,maybe:0};
  state.current = { id:s.id, name:s.name, songArtist:'' };
  postState();
  logPerformance('set_current');
}

function removeSinger(id){
  state.singers=state.singers.filter(x=>x.id!==id);
  if(state.current.id===id){ state.current={id:null,name:'',songArtist:''}; }
  postState();
}
currentSongArtist.addEventListener('input', async ()=>{
  if(!state.current.id) return;
  state.current.songArtist=currentSongArtist.value.trim();
  markEdit('currentSongArtist');
  await postState();
});

/* ---- Voting ---- */
const startBtn  = document.getElementById('start');
const extendBtn = document.getElementById('extend');
const endBtn    = document.getElementById('end');

function announce(result){
  if(result==='encore'){
    resultTag.textContent='Encore!'; resultTag.className='resultTag g';
  } else if(result==='another'){
    resultTag.textContent='Another Shot!'; resultTag.className='resultTag y';
  } else if(result==='maybe'){
    resultTag.textContent='Maybe Next Time!'; resultTag.className='resultTag r';
  } else {
    resultTag.textContent='—'; resultTag.className='resultTag';
  }
}

function postJSON(url, body){
  return fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
}
async function postState(){
  try{
    await postJSON(POST_URL, state);
    await fetchState();
  }catch(e){ console.error(e); }
}

function openVoting(){
  const now = nowMs();
  state.voting.open = true;
  state.voting.prepUntil = 0;
  state.voting.endsAt = now + 30000;
  state.voting.extendCount = 0;
  state.voting.lastResult = null;
  state.voting.voters = {};
  lastCounts = {encore:0,another:0,maybe:0};
  postState();
  sfx.openLoop(true);
  logPerformance('start');
}
function extendVoting(){
  if(!state.voting.open) return;
  state.voting.endsAt += 15000;
  state.voting.extendCount++;
  postState();
  logPerformance('extend');
}
function endVoting(){
  if(!state.voting.open) return;
  state.voting.open=false;
  state.voting.prepUntil=0;
  // calculate winner per tie rules
  const ce=state.voting.counts.encore|0, ca=state.voting.counts.another|0, cm=state.voting.counts.maybe|0;
  let winner='maybe';
  // highest count wins
  const max=Math.max(ce,ca,cm);
  const tieE=ce===max, tieA=ca===max, tieM=cm===max;
  if(tieE && !tieA && !tieM){ winner='encore'; }
  else if(!tieE && tieA && !tieM){ winner='another'; }
  else if(!tieE && !tieA && tieM){ winner='maybe'; }
  else {
    // tie-break logic
    if(tieE && tieA && !tieM) winner='encore';
    else if(!tieE && tieA && tieM) winner='another';
    else if(tieE && tieA && tieM)  winner='another';
    else if(tieE && !tieA && tieM) winner='encore';
  }
  state.voting.lastResult = winner;

  // move singer to winners lists
  if(state.current?.name){
    if(winner==='encore'){ state.winners.encore.push(state.current.name); }
    else if(winner==='another'){ state.winners.another.push(state.current.name); }
    else { /* maybe */ }
  }
  // mark color dot on rotation
  const idx = state.singers.findIndex(s=>s.id===state.current.id);
  if(idx>-1){ state.singers[idx]._color = winner==='encore'?'green': winner==='another'?'yellow':'red'; }

  // "Maybe Next Time!" = elimination (remove from rotation)
  if(winner==='maybe'){ state.singers = state.singers.filter(s=>s.id!==state.current.id); state.current={id:null,name:'',songArtist:''}; }

  postState();
  sfx.openLoop(false);
  sfx.onResult(winner);
  logPerformance('end');
}

startBtn.onclick = openVoting;
extendBtn.onclick = extendVoting;
endBtn.onclick = endVoting;

// quick host vote
document.querySelectorAll('[data-vote]').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const kind = btn.getAttribute('data-vote');
    if(!state.current?.id){ alert('Set the current singer first.'); return; }
    if(!state.voting.open){ alert('Open voting first.'); return; }
    try{
      const dev=deviceId();
      await postJSON(VOTE_URL, { device:dev, vote:kind, singer:state.current.id });
      spawnMini('#miniDots', kind, 1);
    }catch(e){}
  });
});

/* ---- Audio ---- */
const sfx = (function(){
  let enabled=false;
  const aOpen   = new Audio('/assets/voting_open.mp3'); aOpen.loop = true; aOpen.preload='auto';
  const aEncore = new Audio('/assets/encore.mp3');      aEncore.preload='auto';
  const aLoser  = new Audio('/assets/loser.wav');       aLoser.preload='auto';
  let triedWavFallback=false;
  const btn = document.getElementById('enableSound');
  const statusEl  = document.getElementById('soundStatus');
  const loopEl    = document.getElementById('loopStatus');
  function setStatus(){ statusEl.innerHTML = 'Sound: <b>'+(enabled?'on':'off')+'</b>'; }
  function setLoop(v){ loopEl.innerHTML = 'Loop: <b>'+(v?'playing':'stopped')+'</b>'; }
  let ctx=null;
  function waPing(){ try{ if(!ctx) ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(), g=ctx.createGain(); g.gain.value=.0001; o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+.02);}catch(e){} }
  btn.addEventListener('click', async ()=>{
    enabled=!enabled; setStatus();
    if(enabled){ waPing(); try{ await aOpen.play(); aOpen.pause(); }catch(e){} }
  });
  function openLoop(on){
    if(!enabled) return;
    setLoop(on);
    if(on){ aOpen.currentTime=0; aOpen.play().catch(()=>{}); }
    else { aOpen.pause(); aOpen.currentTime=0; }
  }
  function onResult(winner){
    if(!enabled) return;
    if(winner==='encore'){ aEncore.currentTime=0; aEncore.play().catch(()=>{}); }
    else if(winner==='maybe'){
      // some browsers block wav initial playback; try mp3 fallback once
      aLoser.currentTime=0; aLoser.play().catch(async ()=>{
        if(!triedWavFallback){
          triedWavFallback=true;
          try{
            const mp3 = new Audio('/assets/loser.mp3');
            await mp3.play();
          }catch(e){}
        }
      });
    }
  }
  setStatus(); setLoop(false);
  return { openLoop, onResult };
})();

/* ---- PIN ---- */
togglePin.addEventListener('click', ()=>{
  if(pin.type==='password'){ pin.type='text'; togglePin.textContent='Hide'; }
  else { pin.type='password'; togglePin.textContent='Show'; }
});

/* ---- Polling ---- */
let pollTimer=null;
async function tick(){
  if(!pollPaused) await fetchState();
  clearTimeout(pollTimer);
  pollTimer = setTimeout(tick, 1000);
}
tick();

</script>

</body>
</html>
